<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Drifters</title>

    <!-- Open Graph Meta Tags for Discord/Social Media Previews -->
    <meta property="og:title" content="Cosmic Drifters: Your Journey Through the Stars" />
    <meta property="og:description" content="Embark on an interstellar adventure! Discover inspiring cosmic quotes, get game suggestions, and find anonymous support." />
    <meta property="og:image" content="https://cloudedlullaby.github.io/comsic-drifters-banner/banner-preview.png" />
    <meta property="og:url" content="https://cloudedlullaby.github.io/comsic-drifters-banner/" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Cosmic Drifters" />
    <meta name="theme-color" content="#1c004a">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Custom font for "Orbitron" to give a futuristic/sci-fi feel */
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* Keyframes for subtle background animation (for the banner itself) */
        @keyframes starry-background {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Keyframes for more noticeable star twinkling */
        @keyframes twinkle {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.1; }
        }

        /* Keyframes for animated nebula background (for the body) */
        @keyframes nebula-move {
            0% { background-position: 0% 0%; }
            25% { background-position: 50% 50%; }
            50% { background-position: 100% 0%; }
            75% { background-position: 50% 100%; }
            100% { background-position: 0% 0%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 1rem;
            background:
                /* Central bright core - similar to the image's center */
                radial-gradient(circle at 50% 50%, rgba(255, 200, 100, 0.9) 0%, rgba(255, 100, 0, 0.8) 15%, transparent 35%),
                /* Prominent reddish-orange cloud, top-left */
                radial-gradient(circle at 20% 30%, rgba(200, 50, 0, 0.8) 0%, transparent 40%),
                /* Deep purple cloud, lower-right */
                radial-gradient(circle at 80% 70%, rgba(100, 0, 150, 0.9) 0%, transparent 40%),
                /* Bright blue gas, bottom-left */
                radial-gradient(circle at 10% 85%, rgba(0, 100, 255, 0.7) 0%, transparent 45%),
                /* Faint larger pinkish/magenta swirl, top-right */
                radial-gradient(circle at 75% 15%, rgba(255, 50, 200, 0.5) 0%, transparent 55%),
                /* More subtle bluish haze */
                radial-gradient(circle at 40% 60%, rgba(0, 50, 100, 0.6) 0%, transparent 50%),
                #000003;
            background-size: 500% 500%;
            animation: nebula-move 100s ease infinite alternate;
            overflow: hidden;
            position: relative;
        }

        /* Style for the main content area (where banner/explorer will be displayed) */
        .content-area {
            width: 100%;
            max-width: 4xl;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .cosmic-banner, .cosmic-section {
            width: 100%;
            border: 2px solid #6a11cb;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: 1rem;
            background: radial-gradient(circle at top left, #2c0b4e 0%, transparent 70%),
                        radial-gradient(circle at bottom right, #1a0636 0%, transparent 70%),
                        linear-gradient(to right, #0a011a, #1c004a, #0a011a);
            background-size: 200% 200%;
            animation: starry-background 30s ease infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 480px;
        }

        .cosmic-section {
            display: none; /* Hidden by default */
        }


        /* Text glow effect */
        .text-glow {
            text-shadow: 0 0 8px #93c5fd, 0 0 15px #bfdbfe, 0 0 25px #dbeafe;
        }

        /* Custom button styling */
        .btn-cosmic {
            background-image: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(49, 196, 190, 0.75);
        }
        .btn-cosmic:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px 0 rgba(49, 196, 190, 0.9);
        }
        .btn-cosmic:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px 0 rgba(49, 196, 190, 0.5);
        }

        /* Navigation button styling */
        .nav-btn {
            background-color: #3b0764; /* Dark purple */
            color: #e0e7ff; /* Light text */
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* Fully rounded */
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .nav-btn:hover {
            background-color: #4c0a80; /* Slightly lighter purple on hover */
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background-image: linear-gradient(to right, #6a11cb 0%, #2575fc 100%); /* Gradient for active tab */
            box-shadow: 0 4px 15px 0 rgba(49, 196, 190, 0.75);
            border-color: #a78bfa; /* Light purple border for active */
        }

        /* Styling for dynamically created stars */
        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            opacity: 0.9;
            animation: twinkle 4s infinite ease-in-out;
        }

        /* Venting System Specific Styles */
        .vent-card {
            background-color: rgba(30, 0, 60, 0.8); /* Slightly transparent dark background */
            border: 1px solid #4a0d7c;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: left;
            word-wrap: break-word; /* Ensure long words wrap */
        }
        .support-btn {
            background-color: #2575fc;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: background-color 0.2s ease;
        }
        .support-btn:hover:not(:disabled) {
            background-color: #1a5acb;
        }
        .support-btn:disabled {
            background-color: #4a4a4a;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="p-4">

    <div class="content-area">
        <!-- Navigation Buttons -->
        <nav class="flex space-x-4 mb-8">
            <button id="homeTabBtn" class="nav-btn active">Home</button>
            <button id="gameSuggestorTabBtn" class="nav-btn">Game Suggestor</button>
            <button id="ventingTabBtn" class="nav-btn">Venting & Support</button>
        </nav>

        <!-- User ID Display -->
        <div id="userIdDisplay" class="text-white text-sm mb-4">User ID: Loading...</div>

        <!-- Home Section (Cosmic Banner) -->
        <section id="cosmicBanner" class="cosmic-banner flex flex-col items-center justify-center space-y-6">
            <h1 class="text-5xl font-orbitron text-glow">Cosmic Drifters</h1>
            <p class="text-xl text-gray-300">Your Journey Through the Stars</p>
            <div class="quote-container mt-4 p-4 border border-purple-500 rounded-lg bg-purple-900 bg-opacity-50 max-w-lg mx-auto">
                <p id="quoteDisplay" class="text-lg italic text-gray-200">"The universe is not only stranger than we imagine, it is stranger than we can imagine."</p>
                <div id="loadingIndicator" class="hidden text-center text-blue-300 mt-2">Loading...</div>
            </div>
            <button id="generateQuoteBtn" class="btn-cosmic text-white font-bold py-3 px-6 rounded-full text-lg">
                Generate New Cosmic Quote
            </button>
        </section>

        <!-- Game Suggestor Section -->
        <section id="gameSuggestorSection" class="cosmic-section flex-col items-center justify-center space-y-6">
            <h2 class="text-4xl font-orbitron text-glow mb-4">Game Suggestor</h2>
            <div class="suggestion-container mt-4 p-4 border border-blue-500 rounded-lg bg-blue-900 bg-opacity-50 max-w-lg mx-auto">
                <p id="gameSuggestionDisplay" class="text-lg italic text-gray-200">Click below for a game suggestion!</p>
                <div id="gameSuggestionLoadingIndicator" class="hidden text-center text-blue-300 mt-2">Loading...</div>
            </div>
            <button id="suggestGameBtn" class="btn-cosmic text-white font-bold py-3 px-6 rounded-full text-lg">
                Suggest a Game
            </button>
        </section>

        <!-- Venting & Support Section -->
        <section id="ventingSystemSection" class="cosmic-section flex-col items-center justify-center space-y-6">
            <h2 class="text-4xl font-orbitron text-glow mb-4">Vent Your Cosmic Woes</h2>
            <textarea id="ventInput" class="w-full max-w-md p-3 rounded-lg bg-gray-800 text-white border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400" rows="4" placeholder="Share what's on your mind..."></textarea>
            <button id="postVentBtn" class="btn-cosmic text-white font-bold py-3 px-6 rounded-full text-lg">
                Post Anonymously
            </button>
            <div id="ventPostLoading" class="hidden text-center text-blue-300 mt-2">Posting...</div>
            <div id="ventPostMessage" class="hidden text-center text-sm mt-2"></div>

            <h3 class="text-3xl font-orbitron text-glow mt-8 mb-4">Drifters' Support Log</h3>
            <div id="ventsDisplayArea" class="w-full max-w-md bg-gray-900 p-4 rounded-lg shadow-inner overflow-y-auto" style="max-height: 400px;">
                <p id="noVentsMessage" class="text-gray-400 text-center">No vents yet. Be the first to share!</p>
                <!-- Vents will be dynamically loaded here -->
            </div>
        </section>
    </div>

    <!-- Firebase SDKs and Main Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global Firebase instances and user ID
        let fbApp = null;
        let db = null;
        let auth = null;
        let currentUserId = null;
        let isAuthReady = false; // Flag to indicate Firebase auth is ready

        // Firebase Configuration (Canvas will provide these, or use defaults for external hosting)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCBxU1X9eRFoc70KxGKrdEfHLF-LBDLBs0",
            authDomain: "cosmic-drifters.firebaseapp.com",
            projectId: "cosmic-drifters",
            storageBucket: "cosmic-drifters.firebasestorage.app",
            messagingSenderId: "919947237331",
            appId: "1:919947237331:web:0939c62bfeff4b09b8c126",
            measurementId: "G-CGW1J62H51" // measurementId is optional and not strictly needed for core functionality
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Your Gemini API Key
        const GEMINI_API_KEY = "AIzaSyC-dK0r0zIiHrU1L6whT_7uZ1zHLnP6w34";

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase(elements) { // Pass elements object
            const { userIdDisplay, ventsDisplayArea, noVentsMessage } = elements;
            try {
                // Check if firebaseConfig is empty and not running in Canvas (where __firebase_config is provided)
                if (Object.keys(firebaseConfig).length === 0 && typeof __firebase_config === 'undefined') {
                    console.error("Firebase Configuration Missing: Please provide your firebaseConfig object if hosting externally.");
                    if (userIdDisplay) {
                        userIdDisplay.textContent = `User ID: Firebase Config Missing!`;
                    }
                    return; // Stop initialization if config is missing
                }

                if (!fbApp) {
                    fbApp = initializeApp(firebaseConfig);
                    db = getFirestore(fbApp);
                    auth = getAuth(fbApp);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            console.log("Firebase: Authenticated as user:", currentUserId);
                        } else {
                            // If no user, sign in anonymously
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                currentUserId = auth.currentUser.uid;
                                console.log("Firebase: Signed in anonymously as user:", currentUserId);
                            } catch (error) {
                                console.error("Firebase Auth Error:", error);
                                // Fallback if anonymous sign-in fails (e.g., no network)
                                currentUserId = crypto.randomUUID();
                                console.warn("Firebase: Anonymous sign-in failed, using random UUID:", currentUserId);
                            }
                        }
                        isAuthReady = true;
                        if (userIdDisplay) { // Check if element exists before setting textContent
                            userIdDisplay.textContent = `User ID: ${currentUserId}`;
                        }
                        console.log("Firebase: Auth state changed. isAuthReady:", isAuthReady);
                        // Start listening for vents only after auth is ready
                        setupVentsListener(ventsDisplayArea, noVentsMessage); // Pass elements
                    });
                }
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                if (userIdDisplay) { // Check if element exists before setting textContent
                    userIdDisplay.textContent = `User ID: Error (check console)`;
                }
            }
        }

        // --- Tab Switching Logic ---
        function showTab(tabId, elements) { // Pass elements as an object
            const { cosmicBanner, gameSuggestorSection, ventingSystemSection, homeTabBtn, gameSuggestorTabBtn, ventingTabBtn, createStars } = elements;

            // Defensive checks for all elements before accessing style
            if (!cosmicBanner || !gameSuggestorSection || !ventingSystemSection ||
                !homeTabBtn || !gameSuggestorTabBtn || !ventingTabBtn) {
                console.error("showTab: One or more tab elements are null. Cannot switch tabs.");
                return; // Exit if elements are not found
            }

            // Hide all sections
            cosmicBanner.style.display = 'none';
            gameSuggestorSection.style.display = 'none';
            ventingSystemSection.style.display = 'none';

            // Deactivate all nav buttons
            homeTabBtn.classList.remove('active');
            gameSuggestorTabBtn.classList.remove('active');
            ventingTabBtn.classList.remove('active');

            // Show the selected tab and activate its button
            if (tabId === 'home') {
                cosmicBanner.style.display = 'flex';
                homeTabBtn.classList.add('active');
                // Ensure createStars is called with the correct banner element
                if (cosmicBanner.offsetWidth > 0 && cosmicBanner.offsetHeight > 0) {
                    createStars(200, cosmicBanner);
                }
            } else if (tabId === 'gameSuggestor') {
                gameSuggestorSection.style.display = 'flex';
                gameSuggestorTabBtn.classList.add('active');
            } else if (tabId === 'venting') {
                ventingSystemSection.style.display = 'flex';
                ventingTabBtn.classList.add('active');
            }
        }

        // --- Dynamic Starfield Generation (for cosmicBanner only) ---
        function createStars(numStars, cosmicBannerElement) { // Receive cosmicBanner as argument
            if (!cosmicBannerElement) return; // Defensive check

            cosmicBannerElement.querySelectorAll('.star').forEach(star => star.remove());

            const bannerRect = cosmicBannerElement.getBoundingClientRect();
            const bannerWidth = bannerRect.width;
            const bannerHeight = bannerRect.height;

            if (bannerWidth === 0 || bannerHeight === 0) {
                setTimeout(() => createStars(numStars, cosmicBannerElement), 200);
                return;
            }

            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const size = Math.random() * 2 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 4}s`;
                cosmicBannerElement.appendChild(star);
            }
        }

        // --- Gemini API Call for Cosmic Quotes ---
        async function generateQuote(quoteDisplayElement, loadingIndicatorElement, generateQuoteBtnElement) {
            if (!quoteDisplayElement || !loadingIndicatorElement || !generateQuoteBtnElement) {
                console.error("generateQuote: One or more elements are null.");
                return;
            }

            quoteDisplayElement.textContent = '';
            loadingIndicatorElement.classList.remove('hidden');
            generateQuoteBtnElement.disabled = true;

            try {
                let chatHistory = [];
                const prompt = "Generate a short, inspiring quote about space, stars, exploration, or the cosmos. Make it poetic and philosophical. Do not include who said the quote.";
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    const errorMessage = result.error?.message || `HTTP Error: ${response.status} ${response.statusText}`;
                    quoteDisplayElement.textContent = `API Error: ${errorMessage}. Please check your API key or request.`;
                    console.error("Gemini API HTTP Error:", response.status, response.statusText, result);
                    return;
                }

                if (result.error) {
                    const errorMessage = result.error.message || 'Unknown API error in payload.';
                    quoteDisplayElement.textContent = `API Error: ${errorMessage}.`;
                    console.error("Gemini API returned error payload:", result.error);
                    return;
                }

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    quoteDisplayElement.textContent = text;
                } else {
                    quoteDisplayElement.textContent = "Failed to generate quote. Unexpected API response content.";
                    console.error("Gemini API response content structure unexpected:", result);
                }
            } catch (error) {
                quoteDisplayElement.textContent = "Error generating quote. Please check your connection or console for details.";
                console.error("Error calling or parsing Gemini API response:", error);
            } finally {
                loadingIndicatorElement.classList.add('hidden');
                generateQuoteBtnElement.disabled = false;
            }
        }

        // --- Gemini API Call for Game Suggestion ---
        async function suggestGame(gameSuggestionDisplayElement, gameSuggestionLoadingIndicatorElement, suggestGameBtnElement) {
            if (!gameSuggestionDisplayElement || !gameSuggestionLoadingIndicatorElement || !suggestGameBtnElement) {
                console.error("suggestGame: One or more elements are null.");
                return;
            }

            gameSuggestionDisplayElement.textContent = '';
            gameSuggestionLoadingIndicatorElement.classList.remove('hidden');
            suggestGameBtnElement.disabled = true;

            try {
                let chatHistory = [];
                const prompt = `Suggest a fun game or a creative in-game challenge suitable for a small, cozy gaming Discord group. Make the suggestion concise and engaging, like: "Your next mission: [Game/Challenge]!" or "Tonight's pick: [Game/Activity] - [Brief Fun Description]."`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    const errorMessage = result.error?.message || `HTTP Error: ${response.status} ${response.statusText}`;
                    gameSuggestionDisplayElement.textContent = `API Error: ${errorMessage}. Please check your API key or request.`;
                    console.error("Gemini API HTTP Error:", response.status, response.statusText, result);
                    return;
                }

                if (result.error) {
                    const errorMessage = result.error.message || 'Unknown API error in payload.';
                    gameSuggestionDisplayElement.textContent = `API Error: ${errorMessage}.`;
                    console.error("Gemini API returned error payload:", result.error);
                    return;
                }

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    gameSuggestionDisplayElement.textContent = text;
                } else {
                    gameSuggestionDisplayElement.textContent = "Failed to generate suggestion. Unexpected API response content.";
                    console.error("Gemini API response content structure unexpected:", result);
                }
            } catch (error) {
                gameSuggestionDisplayElement.textContent = "Error generating suggestion. Please check your connection or console for details.";
                console.error("Error calling or parsing Gemini API response for game suggestion:", error);
            } finally {
                gameSuggestionLoadingIndicatorElement.classList.add('hidden');
                suggestGameBtnElement.disabled = false;
            }
        }

        // --- Venting System Logic (Firestore) ---
        async function postVent(ventInput, postVentBtn, ventPostLoading, ventPostMessage) { // Pass elements
            if (!ventInput || !postVentBtn || !ventPostLoading || !ventPostMessage) {
                console.error("postVent: One or more elements are null.");
                return;
            }

            const ventText = ventInput.value.trim();
            if (!ventText) {
                ventPostMessage.textContent = "Please type something to vent.";
                ventPostMessage.classList.remove('hidden');
                ventPostMessage.style.color = 'red';
                setTimeout(() => ventPostMessage.classList.add('hidden'), 3000);
                return;
            }

            if (!isAuthReady || !db) {
                ventPostMessage.textContent = "System not ready. Please wait a moment.";
                ventPostMessage.classList.remove('hidden');
                ventPostMessage.style.color = 'orange';
                console.warn("Firestore not ready for posting vent.");
                setTimeout(() => ventPostMessage.classList.add('hidden'), 3000);
                return;
            }

            ventPostLoading.classList.remove('hidden');
            postVentBtn.disabled = true;
            ventPostMessage.classList.add('hidden');

            try {
                const ventsCollectionRef = collection(db, `artifacts/${appId}/public/data/vents`);

                await addDoc(ventsCollectionRef, {
                    text: ventText,
                    timestamp: new Date(),
                    supportCount: 0,
                    supportedBy: []
                });

                ventInput.value = ''; // Clear input
                ventPostMessage.textContent = "Vent posted successfully!";
                ventPostMessage.classList.remove('hidden');
                ventPostMessage.style.color = 'lightgreen';
                setTimeout(() => ventPostMessage.classList.add('hidden'), 3000);

            } catch (error) {
                console.error("Error posting vent:", error);
                ventPostMessage.textContent = "Failed to post vent. Please try again.";
                ventPostMessage.classList.remove('hidden');
                ventPostMessage.style.color = 'red';
            } finally {
                ventPostLoading.classList.add('hidden');
                postVentBtn.disabled = false;
            }
        }

        async function toggleSupport(ventId, currentSupportedBy) {
            if (!isAuthReady || !db || !currentUserId) {
                console.warn("Cannot support: Firebase not ready or user not authenticated.");
                return;
            }

            const ventRef = doc(db, `artifacts/${appId}/public/data/vents/${ventId}`);

            if (currentSupportedBy.includes(currentUserId)) {
                console.log("User already supported this vent.");
                return;
            }

            try {
                await updateDoc(ventRef, {
                    supportCount: (currentSupportedBy.length || 0) + 1,
                    supportedBy: arrayUnion(currentUserId)
                });
                console.log(`Supported vent ${ventId}`);
            } catch (error) {
                console.error("Error supporting vent:", error);
            }
        }

        function setupVentsListener(ventsDisplayAreaElement, noVentsMessageElement) { // Pass elements
            if (!isAuthReady || !db) {
                console.warn("Firestore not ready for listening to vents.");
                if (ventsDisplayAreaElement) {
                    ventsDisplayAreaElement.innerHTML = `<p class="text-gray-400 text-center">Loading vents... (Waiting for Firebase)</p>`;
                }
                return;
            }

            const ventsCollectionRef = collection(db, `artifacts/${appId}/public/data/vents`);
            const q = query(ventsCollectionRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                if (ventsDisplayAreaElement) {
                    ventsDisplayAreaElement.innerHTML = '';
                    if (snapshot.empty) {
                        noVentsMessageElement.classList.remove('hidden');
                        ventsDisplayAreaElement.appendChild(noVentsMessageElement);
                        return;
                    }
                    noVentsMessageElement.classList.add('hidden');

                    snapshot.forEach(doc => {
                        const ventData = doc.data();
                        const ventId = doc.id;
                        const ventText = ventData.text;
                        const supportCount = ventData.supportCount || 0;
                        const supportedBy = ventData.supportedBy || [];
                        const timestamp = ventData.timestamp ? ventData.timestamp.toDate().toLocaleString() : 'Just now';

                        const ventCard = document.createElement('div');
                        ventCard.classList.add('vent-card', 'w-full', 'mb-4');

                        const supportButtonDisabled = supportedBy.includes(currentUserId);

                        ventCard.innerHTML = `
                            <p class="text-gray-100 mb-2">${ventText}</p>
                            <div class="flex justify-between items-center text-gray-400 text-xs">
                                <span>Posted: ${timestamp}</span>
                                <button class="support-btn ${supportButtonDisabled ? 'disabled' : ''}"
                                    data-vent-id="${ventId}"
                                    data-supported-by='${JSON.stringify(supportedBy)}'
                                    ${supportButtonDisabled ? 'disabled' : ''}>
                                    ❤️ Support (${supportCount})
                                </button>
                            </div>
                        `;
                        ventsDisplayAreaElement.appendChild(ventCard);
                    });

                    ventsDisplayAreaElement.querySelectorAll('.support-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const ventId = event.target.dataset.ventId;
                            const supportedBy = JSON.parse(event.target.dataset.supportedBy);
                            toggleSupport(ventId, supportedBy);
                        });
                    });
                }
            }, (error) => {
                console.error("Error listening to vents:", error);
                if (ventsDisplayAreaElement) {
                    ventsDisplayAreaElement.innerHTML = `<p class="text-red-400 text-center">Error loading vents. Please try again.</p>`;
                }
            });
        }


        // --- Event Listeners and Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements - All declarations and assignments are now here
            // These must be retrieved *before* any functions that use them are called or event listeners are set up.
            const cosmicBanner = document.getElementById('cosmicBanner');
            const gameSuggestorSection = document.getElementById('gameSuggestorSection');
            const ventingSystemSection = document.getElementById('ventingSystemSection');
            const homeTabBtn = document.getElementById('homeTabBtn');
            const gameSuggestorTabBtn = document.getElementById('gameSuggestorTabBtn');
            const ventingTabBtn = document.getElementById('ventingTabBtn');

            const generateQuoteBtn = document.getElementById('generateQuoteBtn');
            const quoteDisplay = document.getElementById('quoteDisplay');
            const loadingIndicator = document.getElementById('loadingIndicator');

            const suggestGameBtn = document.getElementById('suggestGameBtn');
            const gameSuggestionDisplay = document.getElementById('gameSuggestionDisplay');
            const gameSuggestionLoadingIndicator = document.getElementById('gameSuggestionLoadingIndicator');

            const ventInput = document.getElementById('ventInput');
            const postVentBtn = document.getElementById('postVentBtn');
            const ventPostLoading = document.getElementById('ventPostLoading');
            const ventPostMessage = document.getElementById('ventPostMessage');
            const ventsDisplayArea = document.getElementById('ventsDisplayArea');
            const noVentsMessage = document.getElementById('noVentsMessage');
            const userIdDisplay = document.getElementById('userIdDisplay');

            // Create an object to hold all DOM elements
            const allDOMElements = {
                cosmicBanner, gameSuggestorSection, ventingSystemSection,
                homeTabBtn, gameSuggestorTabBtn, ventingTabBtn,
                generateQuoteBtn, quoteDisplay, loadingIndicator,
                suggestGameBtn, gameSuggestionDisplay, gameSuggestionLoadingIndicator,
                ventInput, postVentBtn, ventPostLoading, ventPostMessage,
                ventsDisplayArea, noVentsMessage, userIdDisplay
            };

            // Log elements to debug if any are null
            console.log("All DOM Elements retrieved:", allDOMElements);
            for (const key in allDOMElements) {
                if (allDOMElements[key] === null) {
                    console.error(`Element '${key}' is null! This means its ID might be incorrect in the HTML or the element is missing.`);
                }
            }

            // Initialize Firebase, passing the elements object
            initializeFirebase(allDOMElements);

            // Initial tab display, passing the elements object
            // Perform a final check for critical elements before calling showTab
            if (!allDOMElements.cosmicBanner || !allDOMElements.gameSuggestorSection || !allDOMElements.ventingSystemSection ||
                !allDOMElements.homeTabBtn || !allDOMElements.gameSuggestorTabBtn || !allDOMElements.ventingTabBtn) {
                console.error("showTab: Critical tab elements are still null. Cannot switch tabs.");
                return;
            }

            showTab('home', allDOMElements);

            // Attach event listeners, passing relevant elements to their handlers
            // These should now be safe to attach as elements are confirmed to exist.
            if (homeTabBtn) homeTabBtn.addEventListener('click', () => showTab('home', allDOMElements));
            if (gameSuggestorTabBtn) gameSuggestorTabBtn.addEventListener('click', () => showTab('gameSuggestor', allDOMElements));
            if (ventingTabBtn) ventingTabBtn.addEventListener('click', () => showTab('venting', allDOMElements));

            window.addEventListener('resize', () => {
                if (allDOMElements.cosmicBanner && allDOMElements.cosmicBanner.style.display === 'flex') {
                    createStars(200, allDOMElements.cosmicBanner); // Call createStars directly
                }
            });

            if (generateQuoteBtn) {
                generateQuoteBtn.addEventListener('click', () => generateQuote(allDOMElements.quoteDisplay, allDOMElements.loadingIndicator, allDOMElements.generateQuoteBtn));
            }
            if (suggestGameBtn) {
                suggestGameBtn.addEventListener('click', () => suggestGame(allDOMElements.gameSuggestionDisplay, allDOMElements.gameSuggestionLoadingIndicator, allDOMElements.suggestGameBtn));
            }
            if (postVentBtn) {
                postVentBtn.addEventListener('click', () => postVent(allDOMElements.ventInput, allDOMElements.postVentBtn, allDOMElements.ventPostLoading, allDOMElements.ventPostMessage));
            }
        });
    </script>
</body>
</html>
